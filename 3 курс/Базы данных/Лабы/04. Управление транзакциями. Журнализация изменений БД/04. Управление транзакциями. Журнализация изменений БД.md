#### Цель
1. Рассмотреть порядок выполнения транзакций.
2. Изучить механизм ведения журнала изменений БД.
3. Исследовать способы поддержания целостности БД.
  
#### 1. Управление транзакциями и их сериализация
Корректное поддержание транзакций обеспечивает целостность баз данных и обеспечивают изолированность пользователей во многопользовательских системах.  
**Транзакция** – такая неделимая с точки зрения воздействия на БД последовательность операторов манипулирования данными (чтения, удаления, вставки, модификации), что:
- либо результаты всех операторов, входящих в транзакцию,  отображаются в БД,
- либо воздействие всех этих операторов полностью отсутствует.
  
Лозунг транзакций — «Все или ничего»: при завершении транзакции оператором **COMMIT** результаты фиксируются во внешней памяти (commit — «зафиксировать»);  
при завершении транзакции оператором **ROLLBACK** результаты отсутствуют во внешней памяти (rollback — «ликвидировать»).
#### 2. Транзакции и целостность баз данных
Бывают ситуации, при которых целостность БД невозможно не нарушить, выполняя только один оператор изменения БД. Поэтому для поддержания целостности допускается ее нарушение внутри транзакции с условием, чтобы к завершению транзакции целостность была соблюдена. Несоблюдение этого условия приводит к тому, что вместо фиксации результатов транзакции происходит ее откат (т.е. вместо оператора **COMMIT** выполняется оператор **ROLLBACK),** и БД остается в таком состоянии, в котором находилась к моменту начала транзакции, т.е. в целостном состоянии.  
Различают два вида ограничений целостности: немедленно проверяемые и откладываемые.  
**Немедленно проверяемые** ограничения целостности - такие ограничения, проверку которых бессмысленно или невозможно откладывать. Пример: возраст сотрудника - 150 лет. Они реализуются отдельным операторами языкового уровня СУБД. При их нарушениях не производится откат транзакции, а лишь отвергается соответствующий оператор.  
**Откладываемые** ограничения целостности - ограничения на БД, а не на отдельные операции. Эти ограничения проверяются в конце транзакции, и их нарушение вызывает автоматическую замену оператора **COMMIT** на оператор **ROLLBACK.** В некоторых системах существует оператор насильственной проверки ограничения целостности внутри транзакции
#### 3. Изолированность пользователей
В многопользовательских системах с одной БД одновременно работают несколько пользователей или прикладных программ. Система должна обеспечивать изолированность пользователей, т.е. создание иллюзии того, что каждый работает с БД в одиночку.  
Тогда транзакция выступает единицей изолированности пользователей.  
Существуют несколько вариантов изолированности транзакций.  
**1. Отсутствие _потерянных изменений_**.  
Ситуация. Первая транзакция (Т1) изменяет объект БД А. До завершения Т1 вторая транзакция (Т2) также изменяет объект А. Т2 завершается оператором **ROLLBACK** (напр., из-за нарушения ограничения целостности). Тогда при повторном чтении объекта А Т1 не видит изменений объекта, произведенных ранее.  
Диагноз. Ситуация потерянных изменений; противоречие требованию изолированности пользователей.  
Лечение. До завершения Т1 никакая другая транзакция не может изменять объект А.  
Профилактика: Отсутствие потерянных изменений – минимальное требование к СУБД по части синхронизации параллельно выполняемых транзакций.  
**2. Отсутствие чтения «_грязных данных_».**  
Ситуация. Т1 изменяет объект БД А. Параллельно с этим Т2 читает объект А. Т.к. операция изменения еще не завершена, Т2 видит несогласованные «грязные» данные.  
Диагноз. Несоответствие требованию изолированности пользователей: каждый пользователь начинает свою транзакцию при согласованном состоянии базы данных и вправе видеть согласованные данные.  
Профилактика. До завершения Т1, изменившей объект А, никакая другая транзакция не должна читать объект А (минимальным требованием является блокировка чтения объекта А до завершения операции его изменения в Т1).  
**3. Отсутствие неповторяющихся чтений.**  
Ситуация. Т1 читает объект БД А. До завершения Т1 Т2 изменяет объект А и успешно завершается оператором **COMMIT.** Т1 повторно читает объект А и видит его измененное состояние.  
Диагноз. Неповторяющиеся чтения.  
Профилактика. До завершения Т1 никакая другая транзакция не должна изменять объект А. В большинстве систем это является максимальным требованием к синхронизации транзакций.  
**4. Проблема кортежей-«фантомов».**  
Она вызывает ситуации, которые также противоречат изолированности пользователей.  
Ситуация. Т1 выполняет оператор А выборки кортежей отношения R с условием выборки S. До завершения Т1 Т2 вставляет в отношение R новый кортеж К, удовлетворяющий условию S, и успешно завершается. Т1 повторно выполняет оператор А, и в результате появляется кортеж, который отсутствовал при первом выполнении оператора.  
Диагноз. Противоречие идее изолированности транзакций.  
Профилактика. Требуется более высокий уровень синхронизации транзакций. Идеи такой синхронизации (предикатные синхронизационные захваты) известны давно, но в большинстве систем не реализованы.
#### 4. Сериализация транзакций
Чтобы добиться изолированности транзакций, в СУБД должны использоваться методы регулирования совместного выполнения транзакций.  
**Сериализация транзакций** — это механизм их выполнения по некоторому сериальному плану. Способ выполнения набора транзакций называется _сериальным планом_, если результат совместного выполнения транзакций эквивалентен результату некоторого последовательного выполнения этих же транзакций. Только система с сериализацией транзакций  обеспечивает изолированность пользователей.  
Основная проблема реализации состоит в выборе метода сериализации набора транзакций, который не ограничивал бы их параллельность.  
Практические методы сериализации транзакций основывается на учете трех конфликтов между транзакциями:
- **W-W** — Т2 пытается изменять объект, измененный не закончившейся Т1;
- **R-W** — Т2 пытается изменять объект, прочитанный не закончившейся Т1;
- **W-R** — Т2 пытается читать объект, измененный не закончившейся Т1.
#### 5. Методы сериализации транзакций
Существуют два подхода к сериализации транзакций:
- метод синхронизационных захватов объектов БД;
- метод временных меток.
  
Суть обоих подходов состоит в обнаружении конфликтов транзакций и их устранении. Для каждого из подходов имеются две разновидности — пессимистическая и оптимистическая.  
При применении пессимистических методов, ориентированных на ситуации, когда конфликты возникают часто, конфликты распознаются и разрешаются немедленно при их возникновении.  
Оптимистические методы основываются на том, что результаты всех операций модификации БД сохраняются в рабочей памяти транзакций. Реальная модификация БД производится только на стадии фиксации транзакции. Тогда же проверяется, не возникают ли конфликты с другими транзакциями.
#### 6. Синхронизационные захваты
Перед выполнением любой операции в транзакции Т над объектом БД А от имени Т запрашивается синхронизационный захват объекта А в режиме, зависящем от вида операции.  
Основными режимами синхронизационных захватов являются:
- **совместный режим** — S (**S**hared), означающий разделяемый захват  объекта и требуемый для выполнения операции чтения объекта;
- **монопольный режим** — **Х** (e**Х**clusive), означающий монопольный захват объекта и требуемый для выполнения операций занесения, удаления и модификации.
  
Захваты объектов несколькими транзакциями _по чтению_ совместимы, т.е. нескольким транзакциями допускается читать один и тот же объект. Захваты объекта одной транзакцией _по чтению_ не совместим с захватом другой транзакцией того же объекта _по записи_. Захваты одного объекта разными транзакциями _по записи_ не совместимы.
#### 7. Журнализация изменений БД
Одно из требований к СУБД - надежность хранения БД. Для восстановления согласованного состояния БД после аппаратных и программных сбоев поддерживается **журнал изменений** БД.
В основе поддержания целостного состояния БД - механизм транзакций. Общие принципы восстановления:
- результаты зафиксированных транзакций должны быть сохранены в восстановленном состоянии БД;
- результаты незафиксированных транзакций должны отсутствовать в восстановленном состоянии БД.
  
Возможны следующие ситуации, при которых требуется производить восстановление состояния БД:
- **Индивидуальный откат транзакции**. Тривиальной ситуацией отката  является ее явное завершение оператором **ROLLBACK.** Возможны также ситуации, когда откат инициируется системой. Примерами могут быть возникновение исключительной ситуации в прикладной программе (например, деление на ноль) или выбор транзакции в качестве жертвы при обнаружении синхронизационного тупика. Для восстановления согласованного состояния БД при индивидуальном откате транзакции нужно устранить последствия операторов модификации БД, которые выполнялись в этой транзакции.
- **Потеря содержимого оперативной памяти (мягкий сбой)**. Такая ситуация может возникнуть при аварийном выключении электрического питания, при возникновении неустранимого сбоя процессора (например, срабатывании контроля оперативной памяти). Ситуация характеризуется потерей той части БД, которая к моменту сбоя содержалась в буферах оперативной памяти.
- **Поломка основного внешнего носителя БД (жесткий сбой)**. Эта ситуация при достаточно высокой надежности современных устройств внешней памяти может возникать сравнительно редко, но тем не менее, СУБД должна быть в состоянии восстановить БД даже и в этом случае. Основой восстановления является архивная копия и журнал изменений БД.
  
Во всех трех случаях основой восстановления является избыточное хранение данных. Эти избыточные данные хранятся в журнале, содержащем последовательность записей об изменении БД.  
Возможны два варианта ведения журнальной информации.
1. Для каждой транзакции поддерживается отдельный локальный журнал изменений БД этой транзакцией. Эти локальные журналы используются для индивидуальных откатов транзакций, и могут поддерживаться в оперативной (правильнее - в виртуальной) памяти. Кроме того, поддерживается общий журнал БД, используемый для восстановления состояния БД после мягких и жестких сбоев. Этот подход позволяет быстро выполнять индивидуальные откаты транзакций, но приводит к дублированию информации в локальных и общем журналах.
2. Поддержание только общего журнала изменений БД, который используется и при выполнении индивидуальных откатов.
#### 8. Журнализация и буферизация
Журнализация изменений связана и с транзакциями, и с буферизацией страниц БД в ОЗУ. Скорость работы ЦП вместе с ОЗУ и ВЗУ различна и единственный способ достижения эффективности СУБД - буферизация страниц БД в ОЗУ.  
Запись об изменении БД, которая должна поступить в журнал при выполнении любой операции модификации БД, не записывается немедленно во внешнюю память, так как это привело бы к существенному замедлению работы системы. Записи в журнал буферизуются: очередная страница выталкивается во внешнюю память журнала только при полном заполнении записями.  
Но реальная ситуация сложней. Имеются два вида буферов — буфер журнала и буфер страниц ОЗУ, которые содержат связанную информацию. И те, и другие могут выталкиваться во внешнюю память. У них должна быть общая _политика выталкивания_, которая обеспечивала бы возможности восстановления состояния БД после сбоев.  
При индивидуальных откатах транзакций проблем не возникает: содержимое ОЗУ не утрачено, и можно пользоваться как буфером журнала,  так и буфером страниц БД.  
Но при мягком сбое, когда содержимое буферов утрачивается, для восстановления БД надо иметь согласованное состояние журнала и БД во внешней памяти. Принцип этой согласованной _политики выталкивания_ буфера журнала и буферов страниц БД: запись об изменении объекта БД должна попадать во внешнюю память журнала раньше, чем измененный объект оказывается во внешней памяти БД. Протокол журнализации и управления буферизацией называется Write Ahead Log (WAL) — «пиши сначала в журнал».  
Рассмотрим, как можно выполнять операции восстановления БД в различных ситуациях, если в системе поддерживается общий для всех транзакций журнал с общей буферизацией записей, поддерживаемый в соответствии с протоколом WAL.  
**Индивидуальный откат транзакции.** Для выполнения индивидуального отката транзакции по общему журналу, все записи в журнале от данной транзакции связываются в обратный список.  
Для _незакончившихся_ транзакций: началом списка является запись о последнем изменении БД, произведенном данной транзакцией. Для _закончившихся_ транзакций начало списка - запись о конце транзакции, которая обязательно вытолкнута во внешнюю память журнала. Концом списка всегда служит первая запись об изменении БД, произведенном данной транзакцией.  
**Восстановление после мягкого сбоя.** К числу основных проблем восстановления после мягкого сбоя относится то, что одна логическая операция изменения БД может изменять несколько физических блоков БД, например, страницу данных и несколько страниц индексов. Страницы БД буферизуются в оперативной памяти и выталкиваются независимо. Несмотря на применение протокола WAL, после мягкого сбоя набор страниц внешней памяти БД может оказаться несогласованным, т.е. часть страниц внешней памяти соответствует объекту до изменения, часть — после изменения. К такому состоянию объекта не применимы операции логического уровня.  
Состояние внешней памяти БД называется _физически согласованным_, если страницы всех объектов соответствуют состоянию объекта либо после его изменения, либо до изменения. В журнале отмечаются точки физической согласованности БД — моменты времени, в которые во внешней памяти  содержатся согласованные результаты операций, завершившихся до соответствующего момента времени, и отсутствуют результаты операций, которые не завершились, а буфер журнала вытолкнут во внешнюю память. Такие точки называют **tpc** (time of physical consistency - точки физической согласованности).
#### 9. Восстановление после жесткого сбоя
Для восстановления согласованного состояния БД после жесткого сбоя журнала изменений БД недостаточно – нужны журнал и архивная копия БД. Восстановление начинается с обратного копирования БД из архивной копии. Затем для всех закончившихся транзакций выполняется **redo,** т.е. операции выполняются повторно.
Более точно, происходит следующее:
- по журналу в прямом направлении выполняются все операции;
- для транзакций, которые не закончились к моменту сбоя, выполняется откат.
  
Так как жесткий сбой не сопровождается утратой буферов оперативной памяти, можно восстановить БД до такого уровня, чтобы можно было продолжить даже выполнение незакончившихся транзакций. Но обычно это не делается, потому что восстановление после жесткого сбоя — это достаточно длительный процесс.
## Задания
1. Исследовать работу с одной БД средствами СУБД Access. Изучить, каким образом осуществляется незаметная для пользователей работа для случаев:
	- потерянных изменений;
	- чтение грязных данных;
	- неповторяющихся чтений;
	- кортежей-фантомов.
	  
	Для каждой ситуации дать описание проведенного эксперимента, результатов его и сделать выводы.  
2. На примере эксплуатации конкретной БД рассмотреть поведение СУБД, направленное на поддержание целостности БД, для случаев:
	- отката транзакции;
	- мягкого сбоя;
	- жесткого сбоя (без его реализации).
## Контрольные вопросы
1. Опишите, какими средствами достигается изолированность пользователей в многопользовательских системах?
2. Охарактеризуйте методы сериализации транзакций.
3. Какие функции журнала изменений БД?
4. Какими средствами поддерживается целостность БД?
5. Опишите, как происходит взаимодействие с журналом при мягком и жестком сбоях.