## Структура 32-разрядного микропроцессора
![Структура 32-разрядного процессора](../Pictures/07_01.%20Структура%2032-разрядного%20процессора.png)  
- **Процессор чисел с фиксированной точкой**: содержит 32-разрядное АЛУ и 32-разрядный блок регистров общего назначения
	- **АЛУ** предназначено для обработки двоичных чисел длиной в 1, 2 или 4 байта без знака или со знаком, а также двоично-десятичных чисел, не превышающих 99. Двоичные числа со знаком представляются в дополнительном коде
	- **Блок из 8 регистров общего назначения**, часть из которых допускает 16- и 8-разрядное обращение
- **Процессор чисел с плавающей точкой FPU**: состоит из 80-разрядного АЛУ и 80-разрядного блока регистров общего назначения. Используется для обработки чисел с плавающей точкой, целых чисел со знаком длиной 8 байт и двоично-десятичных чисел, начиная со 100
- **Блок управления памятью** состоит из 2 основных блоков:
	- **Блок сегментации** (блок сегментного преобразования адреса)
	- **Блок страничного преобразования адреса**, в состав которого входит блок ассоциативной трансляции страничного адреса TLB
- **Кэш-память**: находится между регистрами процессора и основной памятью. Используется для хранения наиболее часто используемой информации
- **Блок управления**: в состав блока управления входят:
	- **Устройство управления**, которое под действием кода команды вырабатывает набор управляющих сигналов, поступающих на разные узлы процессора и на блок интерфейса внешней шины
	- **Управление защитой** - обеспечивает аппаратную защиту программ и данных по привилегиям
	- **Управление предвыборкой** - реализует опережающее заполнение буфера команд. Буфер команд имеет емкость 32 байта и заполняется командами из следующих ячеек памяти команд по мере своего освобождения. Этим обеспечивается ускорение обработки микропроцессора следующей командой
- **Блок интерфейса внешней шины** - осуществляет электрическое согласование параметров внутренней магистрали с сигналами внешней магистрали, формирование необходимых сигналов на внешнюю магистраль и прием сигналов извне. 
- **Внешняя магистраль** - состоит из 3 шин: 
	- **Шина данных** - 32 разряда
	- **Шина адреса** - передается 32-разрядный адрес по 34-разрядной шине адреса. $A31...A2 + (B3, B2, B1, B0)$. Чтобы с минимальными потерями согласовать 32-разрядную шину данных с передачей данных меньшей разрядности, младшие разряды адреса $A0$ и $A1$ передаются в дешифрованном виде. Они показывают, какие байты из 32-разрядной шины данных в данный момент востребованы: 1-ый байт, 2 младших байта, 2 старших байта или все 32
	- **Шина управления** - 32 разряда. Передает сигналы записи и чтения содержимого ОП из внешних устройств, сигналы запросов прерываний и сигналы прямого доступа к памяти
## Типы чисел 32-разрядного процессора
| Тип                      | Размер, байт                      | Диапазон                        | Обработка |
| ------------------------ | --------------------------------- | ------------------------------- | --------- |
| Целые без знака          | 1                                 | 0...255                         | АЛУ ФТ    |
|                          | 2                                 | 0...65535                       | АЛУ ФТ    |
|                          | 4                                 | 0...$4.3∗10^9$                  | АЛУ ФТ    |
| Целые со знаком          | 1                                 | -128...+127                     | АЛУ ФТ    |
|                          | 2                                 | -32768...+32767                 | АЛУ ФТ    |
|                          | 4                                 | $-2.1∗10^9$...$-2.1∗10^9$       | АЛУ ФТ    |
|                          | 8                                 | $-9.1∗10^{18}$...$-9.1∗10^{18}$ | FPU       |
| С плавающей точкой       | 4 (1+8+23), знак-порядок-мантисса | $\pm3.37∗10^{35}$               | FPU       |
|                          | 8 (1+11+52)                       | $\pm1.67∗10^{308}$              | FPU       |
|                          | 10 (1+15+64)                      | $\pm1.1∗10^{4932}$              | FPU       |
| Двоично-десятичные числа | 1 распакованный                   | 0...9                           | АЛУ ФТ    |
|                          | 1 упакованный                     | 0...9                           | АЛУ ФТ    |
|                          | 10 упакованных                    | 0...9...9 (18 цифр)             | FPU       |
## Регистровая архитектура
В 32-разрядном процессоре выделяют следующие группы регистров:
1. **Основные функциональные регистры** - используются прикладными программами. В их состав входят: 
	- **Регистры общего назначения**:  
		![Регистры общего назначения](../Pictures/07_02.%20Регистры%20общего%20назначения.png)
	- **Регистр указателя команд и регистр флагов**. Регистр указателя команд `EIP` хранит смещение адреса команд относительно начала сегмента кода. Регистр флагов `EFLAGS` содержит признаки результата, а также разряды, управляющие работой микропроцессора:
		- Флаги состояния:
			- `ZF` - признак нуля и результата
			- `OF` - флаг переполнения
			- `CF` - флаг переноса
			- `DF` - флаг направления обработки строк
			- `SF` - флаг знака
			- `PF` - флаг четности
			- `AF` - флаг для работы с двоично-десятичными числами
		- `IF` - флаг прерываний
		- `TF` - флаг трассировки
		- `NT` - вид вложенной задачи - показывает, что данная задача была вызвана из другой задачи, и возврат должен производится по механизму переключения задач
		- `IOPL` - 2-разрядное поле уровня привилегий ввода-вывода
		- `VM` - режим виртуального процессора 8086 (при `VM = 1`). Может быть установлен только в защищенном режиме
		  
		![Регистр указателя команд и регистр флагов](../Pictures/07_03.%20Регистр%20указателя%20команд%20и%20регистр%20флагов.png)
	- **Сегментные регистры**: `CS`, `DS`, `SS`, `ES`, `FS`, `GS` (все по 16 разрядов). При работе микропроцессора в реальном режиме в сегментном регистре содержатся старшие 16 разрядов 20-разрядного базового адреса сегмента. Физический адрес начала сегмента получаются умножением этой величины на 16: $`A_{баз.сегм}=(сегм.регистр)*16`$ Получающийся 20 разрядный адрес позволяет адресовать память с ёмкостью 1 Мб. При переходе к 32-разрядной системе стало необходимо обеспечить адресацию памяти. Введение защищенного режима потребовало хранение дополнительной информации о сегменте: его длине, которая стала переменной, уровне привилегий и т. д. Поэтому все данные о сегменте хранятся в специальных структурах - дескрипторах сегментов, которые хранятся в таблицах дескрипторов. А сегментные регистры, которые сохранили свою длину в 16 разрядов, содержат селектор (указатель), который используется для нахождения нужного дескриптора в таблице
2. **Регистры процессора с плавающей точкой** - используются прикладными программами:
	- **Регистры данных** - могут использоваться как стек или как набор пронумерованных регистров. Старший бит 80-разрядного регистра данных кодирует знак мантиссы. Следующие биты отведены под кодирование порядка. Последнее поле отведено под мантиссу числа. Количество разрядов, отводимых под поля порядка и мантиссы, определяется регистром управления `FPU`.  
		![Регистры данных](../Pictures/07_04.%20Регистры%20данных.png)
	- **Регистры тэгов** - определяют содержимое регистра данных с целью оптимизации и обработки:
		- `00` - достоверное значение в регистре данных
		- `01` - нулевое значение в регистре данных
		- `10` - в регистре данных записано не число
		- `11` - в регистре данных пусто
		  
		Использование тегов позволяет в некоторых случаях сократить время выполнения операции.  
		![Регистры тегов](../Pictures/07_05.%20Регистры%20тэгов.png)
	- **Регистр управления** - управляет округлением к ближайшему значению вверх, вниз и к нулю с точностью (длина мантиссы - 24, 53 или 64 вида), а также содержит маску признаков ошибок, фиксируемую в регистре состояния.
		![Регистр управления](../Pictures/07_06.%20Регистры%20управления%20и%20состояния.png)
	- **Регистр состояния** - содержит указатель блока данных, работающего в режиме стека, признаки результата, признаки ошибок, возникающий при выполнении операции FPU, а также флаг переполнения стека регистра данных.  
		![Регистр состояния](../Pictures/07_06.%20Регистры%20управления%20и%20состояния.png)
	- **Указатель команд** - содержит адрес команды, вызвавшей ошибку. Имеет размер 48 разрядов, причем 16 разрядов содержат селектор соответствующего сегмента, а 32 разряда - смещение внутри сегмента.  
		![Указатели команд и данных](../Pictures/07_07.%20Указатели%20команд%20и%20данных.png)
	- **Указатель данных** - содержит адрес использованного операнда. Имеет размер 48 разрядов, причем 16 разрядов содержат селектор соответствующего сегмента, а 32 разряда - смещение внутри сегмента
3. **Системные регистры** - используются системными программами, имеющими наивысший уровень привилегий. Управляют функционированием процессора и режимами работы его отдельных блоков. Делятся на 2 группы:
	- **Регистры управления**:
		- `CR0` - содержит виды, определяющие режим работы микропроцессора:
			- `PE = 1` - процессор переходит в защищенный режим
			- `PG = 1` - включение страничной адресации памяти
			- `CD`, `NW` - управление режимами работы внутренней кэш-памяти:
				- `CD = 1` - запрет заполнения кэш-памяти
				- `NW = 1` - запрет сквозной записи
			- `MP` - мониторинг сопроцессора
			- `EM = 1` - эмуляция сопроцессора
			- `TS` - флаг переключения задач
			- `NE` - разрешение стандартного механизма сообщения об ошибке через исключения
			- `ET` - индикатор поддержки инструкций сопроцессора
		- `CR1` - зарезервирован
		- `CR2` - содержит линейный адрес, который вызвал страничную ошибку
		- `CR3` - содержит базовый адрес каталога таблиц и страниц. Содержит старшие 20 разрядов, а также биты `PCD` и `PWT`, управляющие работой кэш-памяти при страничной адресации:
			- `PCD = 1` - загрузка содержимого страницы в кэш-память запрещена
			- `PWT = 1` - режим сквозной записи
			- `PWT = 0` - режим обратной записи
		- `CR4` - содержит биты, обеспечивающие расширение функциональных возможностей процессора, начиная с первого:
			- `VME` и `PVI` - управляют работой виртуальных прерываний
			- `PAE` - обеспечивает расширение физического адреса до 36 разрядов
			- `PGE` - определяет некоторые страницы как глобальные
			- `PSE` - расширяет размер адресуемых страниц до 4 Гб
	- **Регистры системных адресов и системных сегментов**  
		![Регистры системных адресов и системных сегментов](../Pictures/07_08.%20Регистры%20системных%20адресов%20и%20системных%20сегментов.png)  
		- `GDTR` - регистр глобальной таблицы дескрипторов. Определяет базовый адрес и размер таблицы
		- `IDTR` - регистр таблицы дескрипторов прерываний. Содержит базовый адрес и размер таблицы
		- `LDTR` - регистр локальной таблицы дескрипторов. Представляет собой селектор, который указывает на положение дескрипторов, описывающих сегмент, где содержится локальная таблица дескрипторов
		- `TR` - регистр задач. Представляет собой селектор, который указывает на положение дескрипторов, описывающих сегмент состояния задачи (`TSS`)
4. **Регистры отладки и тестирования** - используются системными программами, имеющими наивысший уровень привилегий:
	- **Регистры отладки**: `DR0`...`DR7`:
		- `DR0`...`DR3` - содержат линейные адреса 4 контрольных точек останова при отладке
		- `DR4`, `DR5` - не используются, зарезервированы
		- `DR6` - регистр состояния, показывает текущее состояние процессора при останове в этих контрольных точках
		- `DR7` - регистр управления, задает условия останова в контрольных точках
	- **Регистры тестирования**: `TR3`...`TR12` - используются при тестировании кэш-памяти и буфера ассоциативной трансляции адресов страниц `TLB`. По мере развития архитектуры процессора их количество расширяется и дополняется новым содержимым. Существует встроенный алгоритм самотестирования, который осуществляет поиск ошибок в микрокоде и в больших логических матрицах. Внутренние счетчики контролируют работу процессора и проводят отсчет событий
  
Процессор работает в 3 режимах:
- **Реальный режим** - обеспечивается совместимость на уровне объектных входов с микропроцессором 8086. Архитектура 32-разрядного процессора почти полностью идентична архитектуре 16-разрядного процессора. Для программиста 32-разрядный процессор представляется как процессор 8086, выполняющий программы с большей скоростью и обладающий расширенной системой команд и регистрами. Основное ограничение: предельная емкость адресуемой памяти - 1 Мб.  
	Схема получения физического адреса в реальном режиме:  
	![Схема получения физического адреса в реальном режиме](../Pictures/07_09.%20Схема%20получения%20физического%20адреса%20в%20реальном%20режиме.png)
- **Защищенный режим** - размер адресного пространства увеличивается до 4 Мб. В этом режиме процессор обладает более высоким быстродействием и возможностью многозадачности
- **Виртуальный режим** - используется для одновременного исполнения программ, описанных на разных процессорах. Т. е. емкость памяти, адресуемой процессором, не ограничена 1 Мб, как в реальном режиме. Этот режим позволяет формировать несколько виртуальных сред процессора 8086
  
