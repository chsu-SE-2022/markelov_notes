В 1965 г. Уилксом в процессе разработки вычислительной машины Atlas было предложено использовать двухуровневую память, когда между основной памятью и процессором размещается небольшая, но быстро действующая буферная память. Уилкс назвал эту память подчиненной, а затем распространение получил термин **кэш-память**.  
Когда процессор пытается прочитать слово из основной памяти, сначала осуществляется поиск этого слова в кэше. Если такая копия существует, обращение к основной памяти не производится, а в процессор передается слово, извлеченное из кэш-памяти. Такая ситуация называется **успешным обращением** или **попаданием**. При отсутствии нужного слова в кэше, требуемое слово передается из основной памяти и одновременно из основной памяти в кэш пересылается блок данных, содержащих это слово.  
![Структура системы с основной и кэш-памятью](../Pictures/06_01.%20Структура%20системы%20с%20основной%20и%20кэш-памятью.png)  
Основная память состоит из $2^n$ адресуемых слов, причем каждое слово имеет уникальный $n$-разрядный адрес. При взаимодействии с кэш-памятью основная память рассматривается как $M$ блоков фиксированной длины по $k$ слов в каждом ($M=\frac{2^n}{k}$). В свою очередь, кэш-память состоит из $c$ блоков аналогичного размера, называемых **строками**, причем количество строк намного меньше, чем количество блоков ($c<<M$). При считывании слова из какого либо блока основной памяти этот блок копируется в одну из строк кэш-памяти. Т. к. $c<<M$, то отдельная строка не может быть выделена постоянно одному и тому же блоку основной памяти. Поэтому каждой строке кэш-памяти соответствует признак или тег, содержащий сведения, какой блок хранится в данный момент в данной строке. В качестве тега обычно используется часть адреса основной памяти.  
На эффективность применения кэш-памяти влияют следующие моменты:
- **Емкость кэш-памяти**. Выбор емкости кэш-памяти - это определенный компромисс. Т. к., с одной стороны, кэш-память должна быть достаточно мала, чтобы ее стоимость не была высокой. С другой стороны, она должна быть достаточно большой, чтобы среднее время доступа к системе определялось временем доступа к кэш-памяти. Для большинства задач, близкой к оптимальной является кэш-память от 1 до 512 Кб
- **Размер строки**. Когда в кэш-память помещается строка, вместе с требуемым словом попадает и соседнее. По мере увеличения размера строки вероятность промахов сначала падает, т. к. в кэш попадают данные, которые потребуются в ближайшее время. Однако, когда размер строки становится излишне большим, вероятность промахов начинает расти, т. к. большие размеры строки уменьшают общее количество строк, следовательно появляется необходимость частой их замены. По мере увеличения размера строки каждое дополнительное слово оказывается дальше от запрошенного, поэтому оно менее вероятно понадобится в ближайшее время. Наиболее близким к оптимальному является размер строки, равный 4-8 адресуемым единицам. На практике размер строки обычно выбирают равным ширине шины данных между кэшем и основной памятью.
- **Способ отображения основной памяти на кэш-памяти**. Способ отображения должен отвечать 3 требованиям:
	1. Обеспечивать быструю проверку кэш-памяти на наличие в ней копии блока ОП.
	2. Обеспечивать быстрое преобразование адреса блока основной памяти в адрес строки кэша
	3. Требование реализовывать п.1-2 наиболее экономными средствами
	  
	Рассмотрим систему, состоящую из основной памяти емкостью 256 килослов (Кслов) и кэш-памяти емкостью 2 Кслова. Для адресации каждого слова основной памяти необходим 18-разрядный адрес. ОП разбивается на блоки по 16 слов. Всего блоков - $2^{14}=16384$ блока. При такой организации 18-разрядный адрес делится на 2 части: младшие 4 разряда - это адрес слова в пределах блока, а старшие 14 разрядов - это номер блока. В свою очередь, для адресации любого слова в кэш-памяти требуется 11-разрядный адрес. Кэш-память разбита на строки, всего их $2^7=128$ строк. Тогда 11-разрядный адрес слова делится на 2 части: 4 младших разряда - адрес слова в строке, и 7 старших разрядов - это номер или адрес строки в кэш-памяти. Поэтому остается преобразовать 14 разрядный адрес блока основной памяти в 7-разрядный адрес строки кэша.  
	Известно 3 способа отображения основной памяти на кэш:
	1. **Прямое отображение**. Адрес строки и кэш-памяти, на которую может быть отражен блок $j$ основной памяти, однозначно определяется выражением $i=j \mod m$, где $m$ - общее число строк в кэше, $i$ принимает значения от 0 до 127, $j$ принимает значения от 0 до 16383. ОП условно представлена в виде двумерного массива блоков, количество рядов равно количеству строк в кэш-памяти. В каждом ряду последовательно перечислены блоки, переадресуемые на одну и ту же строку в кэше. 14-разрядный адрес блока основной памяти разбивается на 2 поля. Логика кэш-памяти интерпретирует эти 14 бит, как 7-разрядный тег и 7-разрядное поле строки. Поле тег определяет, какой блок будет отображен. Основной недостаток: жесткое закрепление за определенными блоками основной памяти одной строки в кэше. Поэтому, если программа будет поочередно обращаться к разным блокам из одной строки, то будет постоянно происходить обновление строки кэша и вероятность попадания будет низкой.  
		![Прямое отображение](../Pictures/06_02.%20Прямое%20отображение.png)
	2. **Полностью ассоциативное отображение**. Позволяет загрузить любой блок основной памяти в любую строку. В адресе основной памяти выделяется 2 поля: поле тега и поле слова. Поле тега совпадет с адресом блока основной памяти. Для проверки наличия копии блока в кэше логика управления кэш-памятью должна одновременно проверить теги всех строк на совпадение с полем тега адреса. Этому требованию наилучшим образом соответствует ассоциативная память, т. е. тег хранится в ассоциативной памяти тега в кэше. Недостаток - необходимость использования дорогостоящей ассоциативной памяти.  
		![Полностью ассоциативное отображение](../Pictures/06_03.%20Полностью%20ассоциативное%20отображение.png)
	3. **Частично-ассоциативное отображение**. Делится на 2 части.  
		- **Часть 1 - множественно-ассоциативное отображение**. Кэш-память разбивается на $v$ модулей, каждый из которых содержит $k$ слов. На строки, входящие в $i$-тый модуль, могут быть отображены только определенные блоки основной памяти в соответствии с соотношением $i=j\mod v$. $j$ - это адрес блока основной памяти. Размещение блока по строкам модуля произвольное, и для поиска нужной строки в пределах модуля используется ассоциативный принцип. Память в данных кэша разбита на 32 модуля по 4 строки в каждом. Память тегов содержит 32 ячейки, в каждой хранится по 4 тега. Адрес блока ОП делится на 2 части: 9-разрядное поле тега, которое содержит порядковый номер блока, и 5-разрядное поле номера модуля, который однозначно указывает на 1 из модулей кэш-памяти и позволяет определить номера блоков ОП, которые можно отображать на этот модуль. Такими являются блоки ОП, которые при делении на 32 дают в остатке число, совпадающее с номером данного модуля. Именно этот способ наиболее широко распространен в современных микропроцессорах.
			![Множественно-ассоциативное отображение](../Pictures/06_04.%20Множественно-ассоциативное%20отображение.png)
		- **Часть 2 - отображение секторов**. Основная память разбивается на секторы, состоящие из фиксированного числа последовательных блоков. Кэш-память также разбивается на секторы, содержащие такое же количество строк. Отображение сектора на кэш-память осуществляется ассоциативно, т. е. любой сектор из ОП может быть помещен в любой сектор кэша. ОП содержит 1024 сектора, каждый состоит из 16 блоков по 16 слов в каждом. В 14-разрядном адресе блока основной памяти старшие 10 разрядов - это номер сектора, младшие 4 - номер блока внутри сектора. Кэш-память состоит из 8 секторов и 7-разрядного адреса строки в кэше, где 3 старших разряда - это адрес сектора, а 4 младших разряда - номер блока внутри сектора. Задача преобразования адресов сводится к переходу от 10-разрядного номера сектора ОП к 3-разрядному номеру сектора кэша. Это осуществляется с помощью ассоциативной памяти с тегом по 8 слов. Каждая ячейка памяти тегов содержит 13 разрядов. 10 старших разрядов хранят тег - номер сектора ОП, 3 младших - номер сектора кэша. Для проверки наличия копии сектора в кэше производится ассоциативный поиск по 10 старшим разрядам памяти тега. Т. к. размер сектора большой, то копируется только требуемый блок. Для этого к каждой строке кэша добавляется 1 бит информации (бит достоверности), показывающий, относится ли данный блок к текущему сектору или в нем осталась информация из другого сектора.  
			![Отображение секторов](../Pictures/06_05.%20Отображение%20секторов.png)
- **Алгоритм замещения информации в заполненной кэш-памяти**. Т. к. при прямом отображении каждому блоку ОП соответствует только одна определенная строка кэша, и никакой иной выбор удаляемой при замещении строки невозможен, то нет и алгоритмов замещения. При полностью и частично ассоциативных способах требуется алгоритм замещения удаляемой из кэша строки. 
	1. Наиболее эффективным считается алгоритм замещения на основе наиболее давнего использования, т. е. удаляется строка, к которой больше всего не было обращений. 
	2. Алгоритм, который работает по принципу "первый вошел - первый вышел". 
	3. Алгоритм замещения наименее часто использующейся строки. Здесь используется счетчик обращений для каждой строки
	4. Алгоритм произвольного выбора строки для замещения
- **Алгоритм согласования содержимого основной и кэш-памяти**. Т. к. многие устройства ввода-вывода могут напрямую обмениваться информацией с ОП, то возникает ситуация, когда содержимое строки кэша не совпадает с содержимым блока основной памяти. В результате на УВВ может быть выдана из ОП устаревшая информация о процессах, а процессор может использовать старое содержимое кэш-памяти вместо новых данных, загруженных в ОП из УВВ. Для разрешения конфликтной ситуации, когда процессор *???*, используют 2 алгоритма обновления основной памяти:
	1. **Метод сквозной записи**. Прежде всего обновляется слово, хранящееся в основной памяти. Если в кэше есть копия этого слова, то она тоже обновляется
	2. **Метод обратной записи**. Слово заносится только в кэш-память. Если в соответствующей строки в кэш-памяти нет, то нужный блок пересылается из ОП, после чего запись все равно выполняется, только в кэш-памяти. И уже при замещении строки ее предварительно пересылают в соответствующее место основной памяти. В ситуации, когда в ОП из УВВ, минуя процессор доносится новая информация, используют 2 способа: 
		1. Система строится так, чтобы любой ввод информации в память автоматически сопровождался соответствующими изменениями в кэше.
		2. Прямой доступ к памяти допускается только через кэш
- **Число уровней кэш-памяти**. Встроенная кэш-память строится на общем кристалле с процессором и является наиболее эффективной и быстродействующей. Для увеличения общей емкости кэш-памяти второй и последующие уровни вставляют между внутренней кэш-памятью и основной