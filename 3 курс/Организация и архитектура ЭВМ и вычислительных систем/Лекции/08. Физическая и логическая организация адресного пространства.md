Архитектура компьютера различает физическое адресное пространство (ФАП) и логическое адресное пространство (ЛАП). ФАП представляет собой простой одномерный массив байтов, доступ к которому реализуется аппаратурой памяти по адресу, присутствующему на шине адреса. ЛАП организуется самим программистом. Трансляцию логических адресов в физические осуществляет блок управления памятью MMU. ЛАП представляется в виде набора элементарных структур: байтов, сегментов и страниц. В микропроцессорах используют 4 варианта организации ЛАП:
- **Линейная (плоская) ЛАП**. Состоит из массива байтов, не имеющих определенной структуры. Трансляция не нужна, логический адрес совпадает с физическим
- **Сегментированная ЛАП**. Состоит из сегментов, логический адрес содержит 2 части - идентификатор и смещение. Трансляцию адреса производит блок сегментирования MMU
- **Страничная ЛАП**. Состоит из страниц (непрерывных областей памяти) с фиксированным числом байтов. Логический адрес состоит из номера страницы и смещения внутри страницы. Трансляцию логического адреса в физический производит блок страничного преобразования MMU
- **Сегментно-страничная ЛАП**. Состоит из сегментов, которые состоят из страниц. Логический адрес состоит из идентификатора сегмента и смещения внутри сегмента. Блок сегментного преобразования MMU проводит трансляцию логического адреса в номер страницы и смещение в ней, которые затем транслируются в физический адрес блоком страничного преобразования MMU
  
В реальном режиме емкость адресованной памяти составляет 1 Мб. Сегменты имеют фиксированную длину - $2^{16}$ байт. Сегментные регистры содержат старшие 16 бит физического адреса начала сегмента. Сдвинутый на 4 разряда влево селектор дает 20 разрядный базовый адрес сегмента. 16-разрядное смещение либо формируется по заданному режиму адресации операнда, либо извлекается из регистра `EIP` для команды. Физический адрес получается путем сложения физического адреса сегмента и смещения внутри сегмента.  
Схема получения физического адреса в реальном режиме:  
![Схема получения физического адреса в реальном режиме](../Pictures/08_01.%20Схема%20получения%20физического%20адреса%20в%20реальном%20режиме.png)  
В реальном режиме емкость адресуемой памяти увеличивается до 4 Гб. Сегменты могут иметь переменную длину от 1 байта до 4 Гб.  
![Схема получения физического адреса в сегментно-страничном режиме](../Pictures/08_02.%20Схема%20получения%20физического%20адреса%20в%20сегментно-страничном%20режиме.png)  
Логический адрес состоит из 2 частей: селектора и смещения в сегменте. Селектор содержится в сегментном регистре и позволяет найти описание сегмента (дескриптор) в специальной таблице дескрипторов. Дескриптор - это специальная 8-байтная структура данных.  
![Структура дескриптора сегмента](../Pictures/08_03.%20Структура%20дескриптора%20сегмента.png)  
- 32-разрядное поле базового адреса позволяет определить начальный адрес сегмента в любой точке адресного пространства. 
- Поле предела указывает длину сегмента - 1. Если в поле записан 0, то сегмент имеет длину 1 в адресуемых единицах (элементах).  
- Величина элемента определяется битом `G`: 
	- `G = 0` - длина в байтах
	- `G = 1` - длина в страницах
- Бит размерности `D` определяет длину отрисовки операндов, используемых в команде по умолчанию:
	- `D = 0` - длина в байтах
	- `D = 1` - длина в страницах
- Бит `U` - бит пользователя. Используется системными программистами по своему усмотрению. Процессор в своей работе его не использует и не меняет.  
- Байт доступа определяет основные правила обращения с сегментом:
	- Бит присутствия `P` показывает возможность доступа к сегменту. При `P = 1` - сегмент находится в физической памяти
	- 2-разрядное поле `DPL` указывает 1 из 4 возможных уровней привилегий дескриптора, определяющий возможность доступа к сегменту со стороны программы. 0 - самый высокий уровень привилегий
	- Бит обращения `A` при любом обращении к сегменту устанавливается в 1. Используется ОС для того, чтобы отслеживать сегменты, к которым дольше всего не было обращений
	- Поле типа определяет назначение и особенности использования сегмента. 
	- Бит `S`: 
		- `S = 1` - данный дескриптор описывает реальный сегмент памяти
		- `S = 0` - дескриптор описывает специальный системный объект
  
Назначение битов с 3 по 0 байта доступа определяется типом сегмента:
![Формат поля типа байта доступа](../Pictures/08_04.%20Формат%20поля%20типа%20байта%20доступа.png)  
В сегменте кода бит согласования `C` определяет правила обращения, которые обеспечивают защиту сегментов программ. При `C = 1` данный сегмент является подчиненным и лишается защиты по привилегиям. При `C = 0` - это обычный сегмент кода. Бит считывания `R` устанавливает правила обращения к сегменту (на исполнение (`R = 0`) или на исполнение и считывание (`R = 1`)). Запись в сегмент кода запрещена. При любой попытке записи возникает программное прерывание.  
Бит `ED` - бит направления расширения:
- `ED = 1` - сегмент является сегментом стека и смещение в сегменте должно быть больше размера сегмента
- `ED = 0` - это сегмент данных, смещение должно быть меньше либо равно размеру сегмента
  
Бит `W` - бит разрешения записи:
- `W = 1` - разрешено изменение сегмента
- `W = 0` - запись запрещена, при попытке записи возникает программное прерывание
  
В случае обращения за операндом смещение в сегменте формируется процессором по режиму адресации операнда. Смещение в сегменте кода извлекается из регистра указателя команд `EIP`. Сумма извлеченного из дескриптора начального адреса сегмента и сформированного смещения дает линейный адрес. Если в процессоре используется только сегментное преобразование ($PG_{CR0} = 0$), то полученный линейный адрес совпадает с физическим. Если используется и страничный механизм организации памяти, то линейный адрес представляется в виде 2 полей: старшие разряды содержат номер виртуальной страницы, младшие - смещение в странице. Преобразование номера виртуальной страницы в номер физической страницы проводится с помощью специальных системных страниц `КТС` (каталога таблиц и страниц) и `ТС` (таблиц и страниц). Положение `КТС` в памяти определяется системным регистром `CR3`. Физический адрес вычисляется как сумма полученного из `ТС` адреса физической страницы и смещения внутри таблицы линейного адреса.  
Дескрипторы хранятся либо в глобальных таблицах дескрипторов (GDT), либо в локальных таблицах дескрипторов (LDT). В GDT содержатся дескрипторы сегментов, которые доступны всем активным задачам (например, дескрипторы кодов и данных ОС, дескрипторы сегментов состояния задач и дескрипторы сегментов, содержащих LDT). В GDT не содержатся дескрипторы ловушек и прерываний. LDT используются для хранения дескрипторов, доступных только в данной задаче. Количество LDT определяется количеством активных задач в системе. Для нахождения дескриптора в таблице дескрипторов используется селектор, который содержится в одном из сегментных регистров.  
![Формат селектора](../Pictures/08_06.%20Формат%20селектора.png)  
Селектор представляет собой 16-разрядное слово, которое разбито на 3 части. Бит `TI` - индикатор таблицы (`TI = 0` - дескриптор находится в `GDT`, `TI = 1` - дескриптор находится в `LDT`). Поле `Index` - номер дескриптора соответствующей таблицы. 2-битовое поле `RPL` - это уровень привилегий запроса. При обращении `RPL` сравнивается с полем `DPL` в байте доступа. Обращение к дескриптору разрешается, если уровень привилегий запроса не ниже, чем уровень привилегий дескриптора. Максимальное количество дескрипторов, находящихся в таблице, определяется длиной поля индекса селектора и равно $2^{13}$. Т. к. каждый дескриптор имеет длину 8 байт, то максимальный объем любой таблицы дескрипторов равен $2^{16}$ байт.  
Для определения положения дескриптора относительно начала таблицы его номер умножается на 8, т. е. сдвигается влево на 3 разряда. Если селектор обращается к дескриптору из таблицы `GDT`, то полученное смещение сравнивается с хранящей в `GDTR` границей таблицы (поле Предел). Если нарушения границы нет, то смещение прибавляется к содержащемуся к `GDTR` базовому адресу, в результате чего образуется физический адрес выбираемого дескриптора.  
Нулевой дескриптор в `GDT` является пустым и не используется. Селектор с нулевым значением разряда со 2 по 15 называется нуль-индикатором. Он обеспечивает обращение к нулевому дескриптору, а т. к. тот не используется, то происходит прерывание.  
Перед инициированием задачи можно загрузить в регистры `DS` и `ES` пустые селекторы. Если потом не инициализировать эти регистры, то адресация памяти через них вызовет прерывание. Загрузка в `LDTR` пустого селектора допустима. Такая операция сообщает процессору, что в данной задаче не будет использоваться `LDT`.  
Чтобы сократить количество обращений к памяти, начиная с 32-разрядного микропроцессора, применяется так называемое кэширование дескрипторов, т. к. обращение к памяти происходит чаще, чем изменение используемых сегментов и переключение задач. С каждым регистром, содержащим селекторы, ассоциируются теневые или кэш-регистры. При первом считывании дескриптора процессор автоматически считывает нужный дескриптор в соответствующий теневой регистр. Так как теперь дескриптор находится внутри процессора, то для получения линейного адреса необходимо просуммировать эффективный адрес с базовым адресом сегмента из нужного теневого регистра. При переключении с одной задачи на другую для замены используемой `LDT` достаточно загрузить `LDTR` в селектор новой локальной таблицы дескрипторов, а процессор автоматически загрузит теневой регистр в дескриптор новой `LDT` при первом обращении к этому дескриптору. 
1. Если в селекторе `TI = 1`, то дескриптор сегмента берется в локальной таблице дескрипторов, если `TI = 0`, то дескриптор сегмента берется в глобальной таблице дескрипторов. 
2. Нахождение дескриптора `LDT` в `GDT`
3. Чтение дескриптора `LDT` в теневой регистр `LDTR`. По базовому адресу `LDT` в теневом регистре устанавливаем указатель на начало нужной `LDT`. По номеру дескриптора в селекторе находим дескриптор сегмента `LDT`. 
4. Дескриптор сегмента записывается в теневой регистр сегментного регистра. Линейный адрес получается суммированием базового адреса сегмента и смещения сегмента
  
![Получение дескриптора, находящегося в локальной таблице дескрипторов LDT](../Pictures/08_07.%20Получение%20дескриптора,%20находящегося%20в%20локальной%20таблице%20дескрипторов%20LDT.jpg)  
![Получение дескриптора, находящегося в глобальной таблице дескрипторов GDT](../Pictures/08_08.%20Получение%20дескриптора,%20находящегося%20в%20глобальной%20таблице%20дескрипторов%20GDT.jpg)  
Помимо `LDT` и `GDT`, используется дескрипторная таблица прерываний `IDT`. Эта замена старой таблицы векторов прерываний. `IDT` содержит дескрипторы специальных системных объектов, которые определяют точки входа процедуры обработки прерываний. Обращение к `IDT` проводится только аппаратными средствами процессора при возникновении аппаратных прерываний или особых случаях при выполнении программы.  
Таким образом, для перевода процессоров в защищенный режим необходимо создать таблицы `GDT` и `IDT` и инициализировать регистры `GDTR` и `IDTR`. В это время загружаются базовый адрес и размер таблицы. Это действие осуществляется один раз и в дальнейшем содержимое `GDTR` и `IDTR` не меняется